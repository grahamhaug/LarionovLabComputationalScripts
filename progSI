#progSI
#v1.1 
#GCH - 4/24/20

#Extracts E(SCF) and thermodynamic data from opt/freq G16 jobs
#Will print the final optimized geometry from .log files
#v2.0 will have GoodVibes processing included, as well. final v will have a single readable thermo variable in format for extraction to excel

#Determine the name of the input.log - print it at the top of the output
outputName=$(basename "$1" .log)
echo "$outputName"

#output the functional/basis set and dispersion type - if included
functional=$(grep '#p' $1 | head -1 | awk '{print $2}')
dispersion=$(grep '#p' $1 | head -1 | sed -n -e 's/^.*\(empiricaldispersion=[a-z0-9]*\) .*$/\1/p')
if [ ! -z "$dispersion" ]; then
        echo "$functional $dispersion"
else
        echo "$functional"
fi

#print the SCF energy value below functional/dispersion line
awk '/Charge =/,/GINC/ {print}' $1 > selection
awk '/A.U. after/ {print $3,$4,$5;print ""}' selection > energy
tail -2 energy

#print the energy correction block and format appropriately
awk '/Zero-point correction/,/TOTAL/ || /Total/ {print $1,$2,$3,$4,$5,$6,$7,$8};END {print ""}' selection > energyblock
sed -i -e 's/zero-point Energies/ZPE/' energyblock
sed -i -e 's/E (Thermal) CV S/              E, kcal\/mol        CV, cal\/(mol·K)        S, cal\/(mol·K)/' energyblock
sed -i -e 's/\(Total\)[ ]*\([0-9]*\.[0-9]*\)[ ]*\([0-9]*\.[0-9]*\)[ ]*\([0-9]*\.[0-9]*\).*$/\1        \2                    \3                    \4/' energyblock
cat energyblock | sed -e '/^.*KCal\/Mol.*$/d'

#print the charge and multiplicity
multiplicity=$(grep 'Charge =' $1 | head -1 | awk '{print}')
echo "$multiplicity" | sed -e 's/Charge/       Charge/' | sed -e 's/Multiplicity/      Multiplicity/'

#Get line numbers for Start/Stop of the geometry section(s)
#pull out the line numbers for "Redundant internal coordinates" - start lines for geometries in .log files
startGeom=$(awk '/Redundant internal/ {print FNR}' selection | tr '\n\r' ' ')
#save these into an array
IFS=' ' read -r -a startArray <<< "$startGeom"
#pull out the line numbers for "Redundant internal coordinates" - start lines for geometries in .log files
endGeom=$(awk '/Recover conn/ {print FNR}' selection| tr '\n\r' ' ')
#save these into an array
IFS=' ' read -r -a endArray <<< "$endGeom"

#make variables to count the number of elements in each array
startCount="${#startArray[@]}"
endCount="${#endArray[@]]}"

#pass the last start/stop lines - the last geometry match - to these variables for reading into awk
if [[ "$startCount" -eq 0 || -z "$startCount" ]]; then
	#echo "case 1"
	echo "No coordinates found in file"
elif [ "$startCount" -eq 1 ] && [ "$endCount" = 1 ]; then
	#set the line numbers of finalStart/End to the only values
	#echo "case 2"
	finalStart=${startGeom}
	finalEnd=${endGeom}
else
	#if there are more than 1 start/stop counted, choose the last line numbers for each
	#echo "case 3"
	finalStart=${startArray[-1]}
	finalEnd=${endArray[-1]}
fi 

#pull out the geometry and format it in .xyz format - tab separated
if [ "$startCount" -ne 0 ]; then
	awk "NR==$finalStart,NR==$finalEnd" selection > tempGeom
	finalGeom=$(awk -F ',' '{printf "%-5s %-15s %-15s %-15s \n", $1, $3, $4, $5}' tempGeom |  sed -e '/^[^0-9]*$/d')
	echo "$finalGeom"
fi

rm -rf selection energyblock energy energyblock tempGeom








